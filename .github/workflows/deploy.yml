name: Deploy Red Legion Website

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy PHP Website to GCP

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Test SSH connectivity
      run: |
        echo "Testing SSH connection to web server..."
        gcloud compute ssh ubuntu@arccorp-web-server --zone us-central1-a --command "echo 'SSH connection successful!'" --ssh-flag="-o ConnectTimeout=10"

    - name: Deploy website with Ansible
      run: |
        echo "Copying deployment files to server..."
        gcloud compute scp --recurse ansible ubuntu@arccorp-web-server:/tmp/ --zone us-central1-a

        echo "Running Ansible deployment..."
        gcloud compute ssh ubuntu@arccorp-web-server --zone us-central1-a --command "
          cd /tmp/ansible

          # Install Ansible if not present
          if ! command -v ansible-playbook &> /dev/null; then
            sudo apt update -qq
            sudo apt install -y python3-pip
            pip3 install ansible
          fi

          # Deploy the website
          /home/ubuntu/.local/bin/ansible-playbook -i inventory.ini deploy.yml \
            -e 'db_host=localhost' \
            -e 'db_port=3306' \
            -e 'db_name=red_legion_website' \
            -e 'db_user=website_user' \
            -e 'db_pass=temp_password_to_be_changed' \
            -v

          # Clean up deployment files
          rm -rf /tmp/ansible
        "

    - name: Verify deployment
      run: |
        echo "Verifying website is accessible..."
        gcloud compute ssh ubuntu@arccorp-web-server --zone us-central1-a --command "
          echo 'Checking services...'
          systemctl is-active nginx || echo 'Nginx not running'
          systemctl is-active php8.1-fpm || echo 'PHP-FPM not running'
          systemctl is-active mysql || echo 'MySQL not running'

          echo 'Testing web server response...'
          curl -I http://localhost/ || echo 'Website not responding'
        "

        echo "ðŸŽ‰ Deployment completed!"
        echo "Website: http://dev.redlegion.gg/"
        echo "phpMyAdmin: http://dev.redlegion.gg/phpmyadmin"